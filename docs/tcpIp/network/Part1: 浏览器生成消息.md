## 第一章: 浏览器生成消息

<img width="704" alt="屏幕快照 2019-05-03 下午11 41 42" src="https://user-images.githubusercontent.com/42414989/57148835-0b955400-6dfd-11e9-92c9-30658fbcbf22.png">

### 从输入URL开始

URL: Uniform Resource Locator，统一资源定位符。
下面是一些常见的URL类型。

- HTTP/HTTPS协议

<img width="648" alt="屏幕快照 2019-05-03 下午11 45 14" src="https://user-images.githubusercontent.com/42414989/57149064-865e6f00-6dfd-11e9-9c9e-d95120319cf3.png">

- FTP协议

<img width="645" alt="屏幕快照 2019-05-03 下午11 45 37" src="https://user-images.githubusercontent.com/42414989/57149088-97a77b80-6dfd-11e9-8403-ec4d3e51a49c.png">

- File协议

<img width="466" alt="屏幕快照 2019-05-03 下午11 46 17" src="https://user-images.githubusercontent.com/42414989/57149152-adb53c00-6dfd-11e9-9895-ebc2f1aaf646.png">

- mailto协议

<img width="362" alt="屏幕快照 2019-05-03 下午11 46 44" src="https://user-images.githubusercontent.com/42414989/57149195-c0c80c00-6dfd-11e9-82e6-8c719fc3f49b.png">

### 浏览器解析URL

我们这里因为是要访问Web服务器, 因此以HTTP协议为例子, 当用户输入URL地址后, 浏览器根据URL元素规则去解析URL。

<img width="695" alt="屏幕快照 2019-05-03 下午11 49 31" src="https://user-images.githubusercontent.com/42414989/57149366-1f8d8580-6dfe-11e9-9701-cf41f0190f9d.png">

实际上http://www.lab.glasscom.com/dir1/file1.html在服务器存储位置是这样的。
<img width="673" alt="屏幕快照 2019-05-03 下午11 51 08" src="https://user-images.githubusercontent.com/42414989/57149464-5a8fb900-6dfe-11e9-8e38-88963e18bf82.png">

#### 关于某些特殊URL的处理情况

即省略文件名的情况,  如:

```
http://www.lab.glasscom.com/dir/。
http://www.lab.glasscom.com/ (访问根目录)
http://www.lab.glasscom.com
```

如果没有具体文件名, 我们就会去访问服务器上设置好的默认文件名, 这个具体设置根据服务器不同而不同, 大多数是index.html或者default.html。因此，像前面这样省略文件名时，服务器就会访问 /dir/index.html 或者 /dir/default.htm。

还有一种比较特殊的

```
http://www.lab.glasscom.com/whatisthis
```
这种情况会按照下面的惯例进行处理:如果 Web 服务器上存在名为 whatisthis 的文件，则将 whatisthis 作为文件名来处 理;如果存在名为 whatisthis 的目录，则将 whatisthis 作为目录名来处理。

### HTTP 的基本思路

通过解析URL, 我们就知道要访问的目标在哪里, 然后浏览器通过HTTP协议来访问Web服务器。

#### HTTP协议的基本交互

<img width="676" alt="屏幕快照 2019-05-04 上午12 01 38" src="https://user-images.githubusercontent.com/42414989/57150067-d0485480-6dff-11e9-8fad-14c31c93a683.png">

请求消息:
```
1. 客户端会向服务器发送请求消息
2. 请求消息中包含的内容是“对什么”和“进行怎样的操作”两个部分, “对什么”的部分称为 URI, “进行怎样的操作”的部分称为方法。
```

响应消息: 服务器接受到请求消息, 并根据这些要求来完成自己 的工作，然后将结果存放在响应消息中。

##### 常见的HTTP方法

<img width="756" alt="屏幕快照 2019-05-04 上午12 05 01" src="https://user-images.githubusercontent.com/42414989/57150227-4baa0600-6e00-11e9-9a1b-386346942464.png">

### 生成HTTP请求消息

浏览器通过对URL解析后, 确定了Web服务器和文件名, 接下来就是根据这些信息来生成HTTP请求消息。

#### 请求消息有严格的规定格式

<img width="673" alt="屏幕快照 2019-05-04 上午12 08 31" src="https://user-images.githubusercontent.com/42414989/57150401-cffc8900-6e00-11e9-8039-5017dd1a7e5d.png">

#### 顺便解释下响应消息格式

<img width="702" alt="响应消息" src="https://user-images.githubusercontent.com/42414989/57150470-fa4e4680-6e00-11e9-96fa-c5c9a1d2c996.png">

#### 常见的一些HTTP头字段

<img width="747" alt="屏幕快照 2019-05-04 上午12 10 56" src="https://user-images.githubusercontent.com/42414989/57150525-1eaa2300-6e01-11e9-971a-f80345840489.png">
<img width="742" alt="屏幕快照 2019-05-04 上午12 11 24" src="https://user-images.githubusercontent.com/42414989/57150546-2ff32f80-6e01-11e9-9638-081f7074fe79.png">
<img width="747" alt="屏幕快照 2019-05-04 上午12 11 51" src="https://user-images.githubusercontent.com/42414989/57150576-3f727880-6e01-11e9-93af-dca060541fe9.png">
<img width="744" alt="屏幕快照 2019-05-04 上午12 12 29" src="https://user-images.githubusercontent.com/42414989/57150607-54e7a280-6e01-11e9-9764-f4df8b4d3240.png">
<img width="742" alt="屏幕快照 2019-05-04 上午12 13 02" src="https://user-images.githubusercontent.com/42414989/57150638-67fa7280-6e01-11e9-9a7c-999e4f41df6c.png">
<img width="746" alt="屏幕快照 2019-05-04 上午12 13 37" src="https://user-images.githubusercontent.com/42414989/57150667-7ea0c980-6e01-11e9-95f3-cae745d74d51.png">

#### 响应状态码

<img width="739" alt="屏幕快照 2019-05-04 上午12 14 20" src="https://user-images.githubusercontent.com/42414989/57150707-99733e00-6e01-11e9-9f01-ec059b704d8e.png">

### 向 DNS 服务器查询 Web 服务器的 IP 地址

生成HTTP请求消息后, 浏览器委托操作系统把报文发送到服务器, 但是在发送之前我们还需要查询服务器域名对应的IP地址。

#### 关于IP的基础认识

互联网和公司内部的局域网都是基于 TCP/IP 的思路来设计的，所以我 们先来了解 TCP/IP 的基本思路。

<img width="487" alt="屏幕快照 2019-05-04 上午12 22 02" src="https://user-images.githubusercontent.com/42414989/57151126-b9573180-6e02-11e9-8e0a-1d6479a354d0.png">

由一些 小的子网，通过路由器连接起来组成一个大的网络。这里的子网可以理解 为用集线器连接起来的几台计算机，我们将它看作一个单位，称为子网。 将子网通过路由器连接起来，就形成了一个网络 。

在网络中，所有的设备都会被分配一个地址。这个地址就相当于现实 中某条路上的“×× 号 ×× 室”。其中“号”对应的号码是分配给整个子 网的，而“室”对应的号码是分配给子网中的计算机的，这就是网络中的 地址。“号”对应的号码称为网络号，“室”对应的号码称为主机号，这个 地址的整体称为 IP 地址。

一个简单的消息传送的具体过程: 发送者发出的消息首先经过子网中的集线器，转发到距离发送者最近的路由器上。接下来， 路由器会根据消息的目的地判断下一个路由器的位置，然后将消息发送 到下一个路由器，即消息再次经过子网内的集线器被转发到下一个路由 器。前面的过程不断重复，最终消息就被传送到了目的地。

#### IP地址的内部结构

实际的 IP 地址是一串 32 比特的数字，按照 8 比特(1 字节)为一组分成 4 组，分别用十进制表示 然后再用圆点隔开。

这就是我们平常经常见到的 IP 地址格式，但仅凭这一 串数字我们无法区分哪部分是网络号，哪部分是主机号。在 IP 地址的规则 中，网络号和主机号连起来总共是 32 比特，但这两部分的具体结构是不固 定的。在组建网络时，用户可以自行决定它们之间的分配关系，因此，我 们还需要另外的附加信息来表示 IP 地址的内部结构。

<img width="634" alt="屏幕快照 2019-05-04 上午12 28 25" src="https://user-images.githubusercontent.com/42414989/57151445-8eb9a880-6e03-11e9-9c68-2ef2b39b2f9e.png">

这一附加信息称为子网掩码。子网掩码的格式有多种如下图所示:

<img width="702" alt="屏幕快照 2019-05-04 上午12 29 25" src="https://user-images.githubusercontent.com/42414989/57151497-b27cee80-6e03-11e9-8354-caaf9f38d091.png">

子网掩码是一 串与 IP 地址长度相同的 32 比特数字，其左边一半都是 1，右边一半都是0。其中，子网掩码为 1 的部分表示网络号，子网掩码为 0 的部分表示主机 号。

#### 为什么我们需要同时使用域名和IP

TCP/IP 网络是通过 IP 地址来确定通信对象的，因此不知道 IP 地址就无法将消息发送给对方, 因此，在委托操作系统发送消息时，必须要先查询好对方 的 IP 地址。

之所以不在网站里面使用IP地址, 是因为相比 IP 地址来说，网址中还是使用服务器 名称比较好。
当然也有人说那为什么TCP/IP网络不使用域名来确定通信对象?  IP 地址的长度 为 32 比特，也就是 4 字节，相对地，域名最短也要几十个字节，最长甚至 可以达到 255 字节。换句话说，使用 IP 地址只需要处理 4 字节的数字，而 域名则需要处理几十个到 255 个字节的字符，这增加了路由器的负担，传送 数据也会花费更长的时间。

因此最后确认人使用域名, 让服务器使用IP, 那么因此我们需要一种机制来实现域名与IP地址的映射查询。

- Socket 库提供查询 IP 地址的功能

向 DNS 服务器发出查询(基于UDF)，也就是向 DNS 服务器发送查询消息，并接 收服务器返回的响应消息。

向 DNS 服务器发送消息时，我们当然也需要知道 DNS 服 务器的 IP 地址。只不过这个 IP 地址是作为 TCP/IP 的一个设置项目事先设 置好的，不需要再去查询了。不同的操作系统中 TCP/IP 的设置方法也有差 异，Windows 中的设置如图。

<img width="499" alt="屏幕快照 2019-05-04 上午12 42 00" src="https://user-images.githubusercontent.com/42414989/57152232-73e83380-6e05-11e9-96bb-366c220bcaba.png">


对于 DNS 服务器，我们的计算机上 一定有相应的 DNS 客户端，而相当于 DNS 客户端的部分称为 DNS 解析 器，或者简称解析器。通过 DNS 查询 IP 地址的操作称为域名解析，因此 负责执行解析(resolution)这一操作的就叫解析器(resolver)了。

- 通过解析器向 DNS 服务器发出查询

<img width="660" alt="屏幕快照 2019-05-04 上午12 38 48" src="https://user-images.githubusercontent.com/42414989/57152060-020fea00-6e05-11e9-8eee-fb03afe1efa6.png">

调用解析器后，解析器会向 DNS 服务器发送查询消息，然后 DNS 服 务器会返回响应消息。响应消息中包含查询到的 IP 地址，解析器会取出 IP 地址，并将其写入浏览器指定的内存地址中。接 下来，浏览器在向 Web 服务器发送消息时，只要从该内存地址取出 IP 地 址，并将它与 HTTP 请求消息一起交给操作系统就可以了。

#### DNS服务器的接力查询

- DNS 服务器的基本工作

DNS 服务器的基本工作就是接收来自客户端的查询消 息，然后根据消息的内容返回响应。

```
来自客户端的查询消息包含以下 3 种信息

- (a)域名: 服务器、邮件服务器(邮件地址中 @ 后面的部分)的名称
- (b)Class: 在最早设计 DNS 方案时，DNS 在互联网以外的其他网络中的应用也被考虑到了，而 Class 就是用来识别网络的信息。不过，如今除了
互联网并没有其他的网络了，因此 Class 的值永远是代表互联网的 IN
- 记录类型: 表示域名对应何种类型的记录。例如，当类型为 A 时，表示域名 对应的是 IP 地址;当类型为 MX 时，表示域名对应的是邮件服务 器。对于不同的记录类型，服务器向客户端返回的信息也会不同
```
DNS 服务器上事先保存有前面这 3 种信息对应的记录数据, 下图是DNS服务器基本工作流程:
<img width="484" alt="屏幕快照 2019-05-04 上午12 45 01" src="https://user-images.githubusercontent.com/42414989/57152372-ef49e500-6e05-11e9-8e4d-6cd9668c8a29.png">

- 域名的层次结构

互联网中存在着不计其数的服务器，将这些服务器的信息全部保存在一台 DNS 服务器中是不可能的，因此一定 会出现在 DNS 服务器中找不到要查询的信息的情况。下面来看一看此时 DNS 服务器是如何工作的。

其实就是将信息分布保存在多台 DNS 服务器中， 这些 DNS 服务器相互接力配合，从而查找出要查询的信息。

首先，DNS 服务器中的所有信息都是按照域名以分层次的结构来保存 的。层次结构这个词听起来可能有点不容易懂，其实就类似于公司中的事 业集团、部门、科室这样的结构。层次结构能够帮助我们更好地管理大量 的信息。

DNS 中的域名都是用句点来分隔的，比如 www.lab.glasscom.com，这 里的句点代表了不同层次之间的界限，就相当于公司里面的组织结构不用 部、科之类的名称来划分，只是用句点来分隔而已 A。在域名中，越靠右的 位置表示其层级越高，比如 www.lab.glasscom.com 这个域名如果按照公司 里的组织结构来说，大概就是“com 事业集团 glasscom 部 lab 科的 www” 这样。其中，相当于一个层级的部分称为域。因此，com 域的下一层是 glasscom 域，再下一层是 lab 域，再下面才是 www 这个名字。

- 寻找相应的 DNS 服务器并获取 IP 地址

首先，将负责管理下级域的 DNS 服务器的 IP 地址注 册到它们的上级 DNS 服务器中，然后上级 DNS 服务器的 IP 地址再注册到 更上一级的 DNS 服务器中，以此类推。

以前面www.lab.glasscom.com为例, 负责管理 lab.glasscom.com 这个域的 DNS 服务器的 IP 地址需要注册到 glasscom.com 域的 DNS 服务器中，而 glasscom.com 域的 DNS 服务器的 IP 地址又需要注册到 com 域的 DNS 服务器中。这样，我们就可以通过上级 DNS 服务器查询出下级 DNS 服务器的 IP 地址，也就可以向下级 DNS 服务器发送查询请求了。

在互联网 中，com 和 jp 的上面还有一级域，称为根域。根域不像 com、jp 那样有自 己的名字。根域的 DNS 服务器中保管着 com、jp 等的 DNS 服务器的信息。由于上级 DNS 服务器保管着所有下级 DNS 服务器的信息，所以我们可以从根域开始一路往下顺藤摸瓜找到任意 一个域的 DNS 服务器。

实际上，根域 DNS 服务器的相关信息已经包含在 DNS 服务器程序的配置文件中了，因 此只要安装了 DNS 服务器程序，这些信息也就被自动配置好了。

<img width="466" alt="屏幕快照 2019-05-04 上午12 51 14" src="https://user-images.githubusercontent.com/42414989/57152693-bf4f1180-6e06-11e9-9fee-83444f87d871.png">

<img width="488" alt="屏幕快照 2019-05-04 上午12 51 43" src="https://user-images.githubusercontent.com/42414989/57152724-d5f56880-6e06-11e9-93f6-7e08644eaa06.png">

- 通过缓存加快 DNS 服务器的响应

在真实的互联网中，一台 DNS 服务器可以管理多个域的信息, 现实中上级域和下级域有可能共享同一 台 DNS 服务器。在这种情况下，访问上级 DNS 服务器时就可以向下跳过 一级 DNS 服务器，直接返回再下一级 DNS 服务器的相关信息。

此外，有时候并不需要从最上级的根域开始查找，因为 DNS 服务器有一 个缓存功能，可以记住之前查询过的域名。如果要查询的域名和相关信息已 经在缓存中，那么就可以直接返回响应，接下来的查询可以从缓存的位置开 始向下进行。相比每次都从根域找起来说，缓存可以减少查询所需的时间。

并且，当要查询的域名不存在时，“不存在”这一响应结果也会被缓 存。这样，当下次查询这个不存在的域名时，也可以快速响应。

DNS 服务器中保存的信息都设置有一个有效期，当缓存中的信息超过有效期后，数 据就会从缓存中删除。而且，在对查询进行响应时，DNS 服务器也会告知客 户端这一响应的结果是来自缓存中还是来自负责管理该域名的 DNS 服务器。

### 委托协议栈发送消息

知道了 IP 地址之后，就可以委托操作系统内部的协议栈向这个目标 IP 地址，也就是我们要访问的 Web 服务器发送消息了。

<img width="482" alt="屏幕快照 2019-05-04 上午12 55 03" src="https://user-images.githubusercontent.com/42414989/57152853-47cdb200-6e07-11e9-9448-bfe2918b95ca.png">

熟悉网络编程的应该很容易理解套接字。
简述收发数据的操作分为若干个阶段，可以大致总结为以下 4 个。

```
- 创建套接字(创建套接字阶段)
- 将管道连接到服务器端的套接字上(连接阶段)
- 收发数据(通信阶段)
- 断开管道并删除套接字(断开阶段)

```

好了第一章结束了, 第二章详细介绍Tcp/IP传输数据过程。
